{% load i18n %}
{# Encounter card for whiteboard Kanban column #}
{# Used as HTMX partial for real-time updates #}

<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 hover:shadow-md transition-shadow"
     id="encounter-{{ encounter.id }}">
    <!-- Patient Info -->
    <div class="flex items-start justify-between mb-2">
        <div>
            <a href="/staff-{{ staff_token }}/operations/clinical/patients/{{ encounter.patient.id }}/"
               class="font-semibold text-gray-900 hover:text-primary-600">
                {{ encounter.patient.pet.name }}
            </a>
            <p class="text-xs text-gray-500">
                {{ encounter.patient.pet.species|default:"" }}
                {% if encounter.patient.pet.breed %}/ {{ encounter.patient.pet.breed }}{% endif %}
            </p>
        </div>
        <span class="text-xs px-2 py-1 rounded-full
            {% if encounter.encounter_type == 'emergency' %}bg-red-100 text-red-700
            {% elif encounter.encounter_type == 'urgent' %}bg-orange-100 text-orange-700
            {% else %}bg-gray-100 text-gray-600{% endif %}">
            {{ encounter.get_encounter_type_display }}
        </span>
    </div>

    <!-- Chief Complaint -->
    {% if encounter.chief_complaint %}
    <p class="text-sm text-gray-600 mb-2 line-clamp-2">
        {{ encounter.chief_complaint|truncatewords:15 }}
    </p>
    {% endif %}

    <!-- Assignment -->
    <div class="flex items-center gap-2 text-xs text-gray-500 mb-3">
        {% if encounter.assigned_vet %}
        <span class="flex items-center">
            {% include "components/icons/feather.html" with icon="user" class="w-3 h-3 mr-1" %}
            {{ encounter.assigned_vet.get_short_name|default:encounter.assigned_vet.username }}
        </span>
        {% endif %}
        {% if encounter.room %}
        <span class="flex items-center">
            {% include "components/icons/feather.html" with icon="home" class="w-3 h-3 mr-1" %}
            {{ encounter.room }}
        </span>
        {% endif %}
    </div>

    <!-- Wait Time -->
    <div class="flex items-center justify-between text-xs">
        <span class="text-gray-400">
            {% if encounter.checked_in_at %}
                {% trans "Checked in" %}: {{ encounter.checked_in_at|timesince }}
            {% else %}
                {{ encounter.created_at|timesince }}
            {% endif %}
        </span>
    </div>

    <!-- State Transition Buttons -->
    <div class="mt-3 pt-3 border-t border-gray-100 flex flex-wrap gap-1">
        {% if encounter.pipeline_state == 'scheduled' %}
        <button hx-post="/staff-{{ staff_token }}/operations/clinical/encounters/{{ encounter.id }}/transition/"
                hx-vals='{"new_state": "checked_in"}'
                hx-target="#encounter-{{ encounter.id }}"
                hx-swap="outerHTML"
                class="btn btn-xs btn-primary">
            {% trans "Check In" %}
        </button>
        {% elif encounter.pipeline_state == 'checked_in' %}
        <button hx-post="/staff-{{ staff_token }}/operations/clinical/encounters/{{ encounter.id }}/transition/"
                hx-vals='{"new_state": "roomed"}'
                hx-target="#encounter-{{ encounter.id }}"
                hx-swap="outerHTML"
                class="btn btn-xs btn-primary">
            {% trans "Room" %}
        </button>
        {% elif encounter.pipeline_state == 'roomed' %}
        <button hx-post="/staff-{{ staff_token }}/operations/clinical/encounters/{{ encounter.id }}/transition/"
                hx-vals='{"new_state": "in_exam"}'
                hx-target="#encounter-{{ encounter.id }}"
                hx-swap="outerHTML"
                class="btn btn-xs btn-primary">
            {% trans "Start Exam" %}
        </button>
        {% elif encounter.pipeline_state == 'in_exam' %}
        <button hx-post="/staff-{{ staff_token }}/operations/clinical/encounters/{{ encounter.id }}/transition/"
                hx-vals='{"new_state": "checkout"}'
                hx-target="#encounter-{{ encounter.id }}"
                hx-swap="outerHTML"
                class="btn btn-xs btn-success">
            {% trans "Checkout" %}
        </button>
        {% elif encounter.pipeline_state == 'checkout' %}
        <button hx-post="/staff-{{ staff_token }}/operations/clinical/encounters/{{ encounter.id }}/transition/"
                hx-vals='{"new_state": "completed"}'
                hx-target="#encounter-{{ encounter.id }}"
                hx-swap="outerHTML"
                class="btn btn-xs btn-success">
            {% trans "Complete" %}
        </button>
        {% endif %}

        <!-- Cancel option (always available for active states) -->
        {% if encounter.pipeline_state not in 'completed,cancelled,no_show' %}
        <button hx-post="/staff-{{ staff_token }}/operations/clinical/encounters/{{ encounter.id }}/transition/"
                hx-vals='{"new_state": "cancelled"}'
                hx-target="#encounter-{{ encounter.id }}"
                hx-swap="outerHTML"
                hx-confirm="{% trans 'Cancel this encounter?' %}"
                class="btn btn-xs btn-ghost text-gray-400 hover:text-red-500">
            {% trans "Cancel" %}
        </button>
        {% endif %}
    </div>
</div>
