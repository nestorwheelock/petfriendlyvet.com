{% load i18n emr_tags %}
{# Encounter card for whiteboard Kanban column #}
{# Used as HTMX partial for real-time updates #}

<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 hover:shadow-md transition-shadow"
     id="encounter-{{ encounter.id }}"
     data-state="{{ encounter.pipeline_state }}">
    <!-- Patient Info -->
    <div class="flex items-start justify-between mb-2">
        <div>
            <a href="/staff-{{ staff_token }}/core/pets/{{ encounter.patient.pet.id }}/"
               target="_blank"
               class="font-semibold text-gray-900 hover:text-primary-600 inline-flex items-center gap-1"
               title="{% trans 'Open pet record in new tab' %}">
                {{ encounter.patient.pet.name }}
                {% include "components/icons/feather.html" with icon="external-link" class="w-3 h-3 text-gray-400" %}
            </a>
            <p class="text-xs text-gray-500">
                {{ encounter.patient.pet.species|default:"" }}
                {% if encounter.patient.pet.breed %}/ {{ encounter.patient.pet.breed }}{% endif %}
            </p>
        </div>
        <span class="text-xs px-2 py-1 rounded-full
            {% if encounter.encounter_type == 'emergency' %}bg-red-100 text-red-700
            {% elif encounter.encounter_type == 'urgent' %}bg-orange-100 text-orange-700
            {% else %}bg-gray-100 text-gray-600{% endif %}">
            {{ encounter.get_encounter_type_display }}
        </span>
    </div>

    <!-- Owner Info -->
    {% if encounter.patient.pet.owner %}
    <div class="text-xs text-gray-500 mb-2">
        <span class="text-gray-400">{% trans "Owner" %}:</span>
        {% if encounter.patient.pet.owner.person_id %}
        <a href="/staff-{{ staff_token }}/core/parties/people/{{ encounter.patient.pet.owner.person_id }}/"
           target="_blank"
           class="text-gray-600 hover:text-primary-600 inline-flex items-center gap-1">
            {{ encounter.patient.pet.owner.get_full_name|default:encounter.patient.pet.owner.email }}
            {% include "components/icons/feather.html" with icon="external-link" class="w-3 h-3 text-gray-400" %}
        </a>
        {% else %}
        <span class="text-gray-600">
            {{ encounter.patient.pet.owner.get_full_name|default:encounter.patient.pet.owner.email }}
        </span>
        {% endif %}
    </div>
    {% endif %}

    <!-- Chief Complaint -->
    {% if encounter.chief_complaint %}
    <p class="text-sm text-gray-600 mb-2 line-clamp-2">
        {{ encounter.chief_complaint|truncatewords:15 }}
    </p>
    {% endif %}

    <!-- Assignment & Room -->
    <div class="flex flex-wrap items-center gap-2 text-xs text-gray-500 mb-2">
        {% if encounter.assigned_vet %}
        <span class="flex items-center" title="{% trans 'Veterinarian' %}">
            {% include "components/icons/feather.html" with icon="plus-square" class="w-3 h-3 mr-1 text-red-500" %}
            {{ encounter.assigned_vet.get_short_name|default:encounter.assigned_vet.username }}
        </span>
        {% endif %}
        {% if encounter.assigned_tech %}
        <span class="flex items-center" title="{% trans 'Technician' %}">
            {% include "components/icons/feather.html" with icon="clipboard" class="w-3 h-3 mr-1" %}
            {{ encounter.assigned_tech.get_short_name|default:encounter.assigned_tech.username }}
        </span>
        {% endif %}
        {% if encounter.exam_room %}
        <span class="flex items-center" title="{% trans 'Room' %}">
            {% include "components/icons/feather.html" with icon="home" class="w-3 h-3 mr-1" %}
            {{ encounter.exam_room.name }}
        </span>
        {% elif encounter.room %}
        {# Legacy: display old CharField if no exam_room FK #}
        <span class="flex items-center" title="{% trans 'Room' %}">
            {% include "components/icons/feather.html" with icon="home" class="w-3 h-3 mr-1" %}
            {{ encounter.room }}
        </span>
        {% endif %}
    </div>

    <!-- Clinical Quick Actions - Forms -->
    {% if encounter.pipeline_state in 'checked_in,roomed,in_exam,pending_orders,awaiting_results,treatment' %}
    <div class="flex flex-wrap gap-1 mb-2">
        <a href="/staff-{{ staff_token }}/operations/clinical/encounters/{{ encounter.id }}/vitals/"
           class="inline-flex items-center px-2 py-1 text-xs rounded bg-blue-50 text-blue-700 hover:bg-blue-100">
            {% trans "Vitals" %}
        </a>
        <a href="/staff-{{ staff_token }}/operations/clinical/encounters/{{ encounter.id }}/soap/"
           class="inline-flex items-center px-2 py-1 text-xs rounded bg-green-50 text-green-700 hover:bg-green-100">
            {% trans "SOAP" %}
        </a>
        <a href="/staff-{{ staff_token }}/operations/clinical/encounters/{{ encounter.id }}/orders/"
           class="inline-flex items-center px-2 py-1 text-xs rounded bg-purple-50 text-purple-700 hover:bg-purple-100">
            {% trans "Orders" %}
        </a>
        <a href="/staff-{{ staff_token }}/operations/clinical/encounters/{{ encounter.id }}/rx/"
           class="inline-flex items-center px-2 py-1 text-xs rounded bg-orange-50 text-orange-700 hover:bg-orange-100">
            {% trans "Rx" %}
        </a>
    </div>
    {% endif %}

    <!-- Wait Time & Time in State -->
    <div class="text-xs text-gray-400 mb-2 space-y-0.5">
        {% if encounter.checked_in_at %}
            <div>{% trans "Wait" %}: {{ encounter.checked_in_at|duration_clock }}</div>
        {% endif %}
        {# Time in current state #}
        {% if encounter.pipeline_state == 'scheduled' %}
            <div class="text-gray-500">{% trans "Scheduled" %}: {{ encounter.scheduled_at|default:encounter.created_at|duration_clock }}</div>
        {% elif encounter.pipeline_state == 'checked_in' and encounter.checked_in_at %}
            <div class="text-gray-500">{% trans "In queue" %}: {{ encounter.checked_in_at|duration_clock }}</div>
        {% elif encounter.pipeline_state == 'roomed' and encounter.roomed_at %}
            <div class="text-gray-500">{% trans "In room" %}: {{ encounter.roomed_at|duration_clock }}</div>
        {% elif encounter.pipeline_state == 'in_exam' and encounter.exam_started_at %}
            <div class="text-gray-500">{% trans "In exam" %}: {{ encounter.exam_started_at|duration_clock }}</div>
        {% elif encounter.pipeline_state == 'pending_orders' and encounter.exam_ended_at %}
            <div class="text-gray-500">{% trans "Pending orders" %}: {{ encounter.exam_ended_at|duration_clock }}</div>
        {% elif encounter.pipeline_state == 'awaiting_results' and encounter.exam_ended_at %}
            <div class="text-gray-500">{% trans "Awaiting results" %}: {{ encounter.exam_ended_at|duration_clock }}</div>
        {% elif encounter.pipeline_state == 'treatment' and encounter.exam_ended_at %}
            <div class="text-gray-500">{% trans "In treatment" %}: {{ encounter.exam_ended_at|duration_clock }}</div>
        {% elif encounter.pipeline_state == 'checkout' and encounter.exam_ended_at %}
            <div class="text-gray-500">{% trans "At checkout" %}: {{ encounter.exam_ended_at|duration_clock }}</div>
        {% elif encounter.pipeline_state == 'completed' and encounter.discharged_at %}
            <div class="text-gray-500">{% trans "Completed" %}: {{ encounter.discharged_at|duration_clock }}</div>
        {% endif %}
    </div>

    <!-- Actions Row -->
    <div class="pt-2 border-t border-gray-100 flex items-center gap-2">
        <!-- Primary Action Button -->
        {% if encounter.pipeline_state == 'scheduled' %}
        <button hx-post="/staff-{{ staff_token }}/operations/clinical/encounters/{{ encounter.id }}/transition/"
                hx-vals='{"new_state": "checked_in"}'
                hx-target="#encounter-{{ encounter.id }}"
                hx-swap="outerHTML"
                class="btn btn-xs !bg-yellow-500 hover:!bg-yellow-600 text-white border-none">
            {% trans "Check In" %}
        </button>
        {% elif encounter.pipeline_state == 'checked_in' %}
        <button hx-post="/staff-{{ staff_token }}/operations/clinical/encounters/{{ encounter.id }}/transition/"
                hx-vals='{"new_state": "roomed"}'
                hx-target="#encounter-{{ encounter.id }}"
                hx-swap="outerHTML"
                class="btn btn-xs !bg-green-500 hover:!bg-green-600 text-white border-none">
            {% trans "Room" %}
        </button>
        {% elif encounter.pipeline_state == 'roomed' %}
        <button hx-post="/staff-{{ staff_token }}/operations/clinical/encounters/{{ encounter.id }}/transition/"
                hx-vals='{"new_state": "in_exam"}'
                hx-target="#encounter-{{ encounter.id }}"
                hx-swap="outerHTML"
                class="btn btn-xs !bg-teal-500 hover:!bg-teal-600 text-white border-none">
            {% trans "Start Exam" %}
        </button>
        {% elif encounter.pipeline_state == 'in_exam' %}
        <button hx-post="/staff-{{ staff_token }}/operations/clinical/encounters/{{ encounter.id }}/transition/"
                hx-vals='{"new_state": "checkout"}'
                hx-target="#encounter-{{ encounter.id }}"
                hx-swap="outerHTML"
                class="btn btn-xs !bg-purple-500 hover:!bg-purple-600 text-white border-none">
            {% trans "Checkout" %}
        </button>
        {% elif encounter.pipeline_state == 'checkout' %}
        <button hx-post="/staff-{{ staff_token }}/operations/clinical/encounters/{{ encounter.id }}/transition/"
                hx-vals='{"new_state": "completed"}'
                hx-target="#encounter-{{ encounter.id }}"
                hx-swap="outerHTML"
                class="btn btn-xs !bg-orange-500 hover:!bg-orange-600 text-white border-none">
            {% trans "Complete" %}
        </button>
        {% elif encounter.pipeline_state == 'completed' %}
        <span class="text-xs text-green-600">
            {% include "components/icons/feather.html" with icon="check-circle" class="w-3 h-3 inline mr-1" %}
            {% trans "Completed" %}
        </span>
        {% endif %}

        <!-- State Selector (Move To) -->
        {% if encounter.pipeline_state not in 'cancelled,no_show' %}
        <select onchange="if(this.value) { htmx.ajax('POST', '/staff-{{ staff_token }}/operations/clinical/encounters/{{ encounter.id }}/transition/', {target:'#encounter-{{ encounter.id }}', swap:'outerHTML', values:{new_state: this.value}}); this.value=''; }"
                class="text-xs border-gray-300 rounded py-1 px-2">
            <option value="">{% trans "Move to..." %}</option>
            {% if encounter.pipeline_state != 'checked_in' and encounter.pipeline_state != 'completed' %}
            <option value="checked_in">{% trans "Checked In" %}</option>
            {% endif %}
            {% if encounter.pipeline_state != 'roomed' and encounter.pipeline_state != 'completed' %}
            <option value="roomed">{% trans "Roomed" %}</option>
            {% endif %}
            {% if encounter.pipeline_state != 'in_exam' %}
            <option value="in_exam">{% trans "In Exam" %}</option>
            {% endif %}
            {% if encounter.pipeline_state != 'checkout' %}
            <option value="checkout">{% trans "Checkout" %}</option>
            {% endif %}
            {% if encounter.pipeline_state != 'completed' %}
            <option value="completed">{% trans "Completed" %}</option>
            {% endif %}
            {% if encounter.pipeline_state == 'completed' %}
            <option value="in_exam">{% trans "Reopen → In Exam" %}</option>
            <option value="checkout">{% trans "Reopen → Checkout" %}</option>
            {% endif %}
        </select>

        <!-- Edit Link -->
        <a href="/staff-{{ staff_token }}/operations/clinical/encounters/{{ encounter.id }}/edit/"
           class="btn btn-xs btn-ghost" title="{% trans 'Edit' %}">
            {% include "components/icons/feather.html" with icon="edit-2" class="w-3 h-3" %}
        </a>

        <!-- Cancel/No Show -->
        {% if encounter.pipeline_state not in 'completed' %}
        <button hx-post="/staff-{{ staff_token }}/operations/clinical/encounters/{{ encounter.id }}/transition/"
                hx-vals='{"new_state": "no_show"}'
                hx-target="#encounter-{{ encounter.id }}"
                hx-swap="outerHTML"
                hx-confirm="{% trans 'Mark as no-show?' %}"
                class="btn btn-xs btn-ghost text-orange-500" title="{% trans 'No Show' %}">
            NS
        </button>
        {% endif %}
        {% endif %}
    </div>
</div>
