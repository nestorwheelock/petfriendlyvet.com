{% extends "base_staff.html" %}
{% load i18n humanize %}

{% block title %}{% trans "Inventory Dashboard" %}{% endblock %}

{% block staff_content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">{% trans "Inventory Dashboard" %}</h1>
            <p class="text-gray-600 mt-1">{% trans "Stock levels, alerts, and recent activity" %}</p>
        </div>
    </div>

    <!-- Summary KPIs -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
        <div class="bg-white rounded-xl shadow p-6">
            <p class="text-sm text-gray-500 mb-1">{% trans "Total Inventory Value" %}</p>
            <p class="text-3xl font-bold text-gray-900">${{ total_value|floatformat:2|intcomma }}</p>
        </div>
        <div class="bg-white rounded-xl shadow p-6">
            <p class="text-sm text-gray-500 mb-1">{% trans "Products Tracked" %}</p>
            <p class="text-3xl font-bold text-gray-900">{{ total_products }}</p>
        </div>
        <div class="bg-white rounded-xl shadow p-6">
            <p class="text-sm text-gray-500 mb-1">{% trans "Active Locations" %}</p>
            <p class="text-3xl font-bold text-gray-900">{{ total_locations }}</p>
        </div>
    </div>

    <!-- Alert Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
        <a href="/staff-{{ staff_token }}/operations/inventory/alerts/?filter=out_of_stock" class="bg-white rounded-xl shadow p-4 hover:shadow-lg transition {% if out_of_stock_count > 0 %}border-l-4 border-red-600{% endif %}">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs text-gray-500 uppercase">{% trans "Out of Stock" %}</p>
                    <p class="text-2xl font-bold {% if out_of_stock_count > 0 %}text-red-600{% else %}text-gray-900{% endif %}">{{ out_of_stock_count }}</p>
                </div>
                <span class="text-2xl">üö´</span>
            </div>
        </a>

        <a href="/staff-{{ staff_token }}/operations/inventory/alerts/?filter=low_stock" class="bg-white rounded-xl shadow p-4 hover:shadow-lg transition {% if low_stock_count > 0 %}border-l-4 border-yellow-500{% endif %}">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs text-gray-500 uppercase">{% trans "Low Stock" %}</p>
                    <p class="text-2xl font-bold {% if low_stock_count > 0 %}text-yellow-600{% else %}text-gray-900{% endif %}">{{ low_stock_count }}</p>
                </div>
                <span class="text-2xl">üìâ</span>
            </div>
        </a>

        <a href="/staff-{{ staff_token }}/operations/inventory/expiring/" class="bg-white rounded-xl shadow p-4 hover:shadow-lg transition {% if expiring_count > 0 %}border-l-4 border-orange-500{% endif %}">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs text-gray-500 uppercase">{% trans "Expiring Soon" %}</p>
                    <p class="text-2xl font-bold {% if expiring_count > 0 %}text-orange-600{% else %}text-gray-900{% endif %}">{{ expiring_count }}</p>
                </div>
                <span class="text-2xl">‚è∞</span>
            </div>
        </a>

        <a href="/staff-{{ staff_token }}/operations/inventory/alerts/?filter=expired" class="bg-white rounded-xl shadow p-4 hover:shadow-lg transition {% if expired_count > 0 %}border-l-4 border-red-500{% endif %}">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs text-gray-500 uppercase">{% trans "Expired" %}</p>
                    <p class="text-2xl font-bold {% if expired_count > 0 %}text-red-600{% else %}text-gray-900{% endif %}">{{ expired_count }}</p>
                </div>
                <span class="text-2xl">‚ò†Ô∏è</span>
            </div>
        </a>

        <a href="/staff-{{ staff_token }}/operations/inventory/purchase-orders/" class="bg-white rounded-xl shadow p-4 hover:shadow-lg transition">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs text-gray-500 uppercase">{% trans "Pending POs" %}</p>
                    <p class="text-2xl font-bold text-primary-600">{{ pending_po_count }}</p>
                </div>
                <span class="text-2xl">üì¶</span>
            </div>
        </a>
    </div>

    <!-- Critical Alerts Section -->
    {% if out_of_stock_items or expired_batches or low_stock_items %}
    <div class="bg-red-50 border border-red-200 rounded-xl p-6 mb-8">
        <h2 class="font-semibold text-red-800 mb-4 flex items-center gap-2">
            <span>‚ö†Ô∏è</span> {% trans "Critical Alerts - Action Required" %}
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {% if out_of_stock_items %}
            <div>
                <h3 class="text-sm font-medium text-red-700 mb-2">{% trans "Out of Stock" %} ({{ out_of_stock_count }})</h3>
                <ul class="space-y-2">
                    {% for item in out_of_stock_items %}
                    <li class="bg-white rounded-lg p-2 shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-900">{{ item.product.name }}</p>
                            <p class="text-xs text-gray-500">{{ item.location.name }}</p>
                        </div>
                        <a href="/staff-{{ staff_token }}/operations/inventory/stock/{{ item.pk }}/adjust/" class="text-xs bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700">
                            {% trans "Restock" %}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if expired_batches %}
            <div>
                <h3 class="text-sm font-medium text-red-700 mb-2">{% trans "Expired Items" %} ({{ expired_count }})</h3>
                <ul class="space-y-2">
                    {% for batch in expired_batches %}
                    <li class="bg-white rounded-lg p-2 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-900">{{ batch.product.name }}</p>
                                <p class="text-xs text-gray-500">{{ batch.batch_number }} - {{ batch.location.name }}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-red-600 font-medium">{{ batch.expiry_date }}</p>
                                <p class="text-xs text-gray-500">{{ batch.current_quantity }} units</p>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if low_stock_items %}
            <div>
                <h3 class="text-sm font-medium text-yellow-700 mb-2">{% trans "Low Stock" %} ({{ low_stock_count }})</h3>
                <ul class="space-y-2">
                    {% for item in low_stock_items %}
                    <li class="bg-white rounded-lg p-2 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-900">{{ item.product.name }}</p>
                                <p class="text-xs text-gray-500">{{ item.location.name }}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-bold text-yellow-600">{{ item.quantity|floatformat:0 }}</p>
                                <p class="text-xs text-gray-500">{% trans "min" %}: {{ item.min_level|floatformat:0 }}</p>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Reorder Suggestions -->
    {% if reorder_suggestions %}
    <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-8">
        <h2 class="font-semibold text-blue-800 mb-4 flex items-center gap-2">
            <span>üîÑ</span> {% trans "Reorder Suggestions" %}
        </h2>
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr class="text-xs text-blue-700 uppercase">
                        <th class="text-left py-2">{% trans "Product" %}</th>
                        <th class="text-left py-2">{% trans "Supplier" %}</th>
                        <th class="text-right py-2">{% trans "Current" %}</th>
                        <th class="text-right py-2">{% trans "Reorder Point" %}</th>
                        <th class="text-right py-2">{% trans "Suggested Qty" %}</th>
                        <th class="text-right py-2"></th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-blue-100">
                    {% for suggestion in reorder_suggestions %}
                    <tr class="bg-white">
                        <td class="py-2 text-sm font-medium text-gray-900">{{ suggestion.rule.product.name }}</td>
                        <td class="py-2 text-sm text-gray-600">{% if suggestion.rule.preferred_supplier %}{{ suggestion.rule.preferred_supplier.name }}{% else %}-{% endif %}</td>
                        <td class="py-2 text-sm text-right text-red-600 font-medium">{{ suggestion.current_stock|floatformat:0 }}</td>
                        <td class="py-2 text-sm text-right text-gray-600">{{ suggestion.rule.reorder_point|floatformat:0 }}</td>
                        <td class="py-2 text-sm text-right text-blue-600 font-medium">{{ suggestion.rule.reorder_quantity|floatformat:0 }}</td>
                        <td class="py-2 text-right">
                            <a href="/staff-{{ staff_token }}/operations/inventory/purchase-orders/create/{% if suggestion.rule.preferred_supplier %}?product={{ suggestion.rule.product.pk }}&supplier={{ suggestion.rule.preferred_supplier.pk }}&quantity={{ suggestion.rule.reorder_quantity }}{% endif %}" class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">
                                {% trans "Create PO" %}
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Quick Action Buttons -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
        <a href="/staff-{{ staff_token }}/operations/inventory/movements/add/" class="bg-primary-600 text-white rounded-xl shadow p-4 text-center hover:bg-primary-700 transition">
            <span class="text-2xl block mb-2">+</span>
            <span class="text-sm font-medium">{% trans "Record Movement" %}</span>
        </a>
        <a href="/staff-{{ staff_token }}/operations/inventory/purchase-orders/create/" class="bg-blue-600 text-white rounded-xl shadow p-4 text-center hover:bg-blue-700 transition">
            <span class="text-2xl block mb-2">+</span>
            <span class="text-sm font-medium">{% trans "Create PO" %}</span>
        </a>
        <a href="/staff-{{ staff_token }}/operations/inventory/stock-counts/create/" class="bg-green-600 text-white rounded-xl shadow p-4 text-center hover:bg-green-700 transition">
            <span class="text-2xl block mb-2">+</span>
            <span class="text-sm font-medium">{% trans "Start Count" %}</span>
        </a>
        <a href="/staff-{{ staff_token }}/operations/inventory/transfers/create/" class="bg-purple-600 text-white rounded-xl shadow p-4 text-center hover:bg-purple-700 transition">
            <span class="text-2xl block mb-2">+</span>
            <span class="text-sm font-medium">{% trans "Transfer Stock" %}</span>
        </a>
    </div>

    <!-- Navigation Links -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
        <a href="/staff-{{ staff_token }}/operations/inventory/stock/" class="bg-white rounded-xl shadow p-4 text-center hover:shadow-lg transition">
            <span class="text-2xl block mb-2">üìä</span>
            <span class="text-sm font-medium text-gray-700">{% trans "Stock Levels" %}</span>
        </a>
        <a href="/staff-{{ staff_token }}/operations/inventory/batches/" class="bg-white rounded-xl shadow p-4 text-center hover:shadow-lg transition">
            <span class="text-2xl block mb-2">üè∑Ô∏è</span>
            <span class="text-sm font-medium text-gray-700">{% trans "Batches" %}</span>
        </a>
        <a href="/staff-{{ staff_token }}/operations/inventory/movements/" class="bg-white rounded-xl shadow p-4 text-center hover:shadow-lg transition">
            <span class="text-2xl block mb-2">üîÑ</span>
            <span class="text-sm font-medium text-gray-700">{% trans "Movements" %}</span>
        </a>
        <a href="/staff-{{ staff_token }}/operations/inventory/suppliers/" class="bg-white rounded-xl shadow p-4 text-center hover:shadow-lg transition">
            <span class="text-2xl block mb-2">üè¢</span>
            <span class="text-sm font-medium text-gray-700">{% trans "Suppliers" %}</span>
        </a>
    </div>

    <!-- Configuration Links -->
    <div class="bg-white rounded-xl shadow p-6 mb-8">
        <h2 class="font-semibold text-gray-900 mb-4">{% trans "Configuration" %}</h2>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
            <a href="/staff-{{ staff_token }}/operations/inventory/locations/" class="border border-gray-200 rounded-lg p-3 text-center hover:bg-gray-50 transition">
                <span class="text-xl block mb-1">üìç</span>
                <span class="text-sm font-medium text-gray-700">{% trans "Locations" %}</span>
            </a>
            <a href="/staff-{{ staff_token }}/operations/inventory/location-types/" class="border border-gray-200 rounded-lg p-3 text-center hover:bg-gray-50 transition">
                <span class="text-xl block mb-1">üè∑Ô∏è</span>
                <span class="text-sm font-medium text-gray-700">{% trans "Location Types" %}</span>
            </a>
            <a href="/staff-{{ staff_token }}/operations/inventory/reorder-rules/" class="border border-gray-200 rounded-lg p-3 text-center hover:bg-gray-50 transition">
                <span class="text-xl block mb-1">üìã</span>
                <span class="text-sm font-medium text-gray-700">{% trans "Reorder Rules" %}</span>
            </a>
            <a href="/staff-{{ staff_token }}/operations/inventory/product-suppliers/" class="border border-gray-200 rounded-lg p-3 text-center hover:bg-gray-50 transition">
                <span class="text-xl block mb-1">üîó</span>
                <span class="text-sm font-medium text-gray-700">{% trans "Product-Suppliers" %}</span>
            </a>
        </div>
    </div>

    <!-- Pending Actions Section -->
    {% if draft_pos or pos_to_receive or counts_in_progress %}
    <div class="bg-amber-50 border border-amber-200 rounded-xl p-6 mb-8">
        <h2 class="font-semibold text-gray-900 mb-4">{% trans "Pending Actions" %}</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {% if draft_pos %}
            <div>
                <h3 class="text-sm font-medium text-amber-800 mb-2">{% trans "Draft POs to Submit" %}</h3>
                <ul class="space-y-2">
                    {% for po in draft_pos %}
                    <li class="flex items-center justify-between bg-white rounded-lg p-2 shadow-sm">
                        <a href="/staff-{{ staff_token }}/operations/inventory/purchase-orders/{{ po.pk }}/" class="text-sm font-medium text-primary-600 hover:underline">
                            {{ po.po_number }}
                        </a>
                        <span class="text-xs text-gray-500">{{ po.supplier.name }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if pos_to_receive %}
            <div>
                <h3 class="text-sm font-medium text-amber-800 mb-2">{% trans "POs Ready to Receive" %}</h3>
                <ul class="space-y-2">
                    {% for po in pos_to_receive %}
                    <li class="flex items-center justify-between bg-white rounded-lg p-2 shadow-sm">
                        <a href="/staff-{{ staff_token }}/operations/inventory/purchase-orders/{{ po.pk }}/receive/" class="text-sm font-medium text-primary-600 hover:underline">
                            {{ po.po_number }}
                        </a>
                        <span class="text-xs text-gray-500">{{ po.get_status_display }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if counts_in_progress %}
            <div>
                <h3 class="text-sm font-medium text-amber-800 mb-2">{% trans "Counts in Progress" %}</h3>
                <ul class="space-y-2">
                    {% for count in counts_in_progress %}
                    <li class="flex items-center justify-between bg-white rounded-lg p-2 shadow-sm">
                        <a href="/staff-{{ staff_token }}/operations/inventory/stock-counts/{{ count.pk }}/" class="text-sm font-medium text-primary-600 hover:underline">
                            {{ count.location.name }}
                        </a>
                        <span class="text-xs text-gray-500">{{ count.get_status_display }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Recent Movements -->
        <div class="bg-white rounded-xl shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <h2 class="font-semibold text-gray-900">{% trans "Recent Movements" %}</h2>
                <a href="/staff-{{ staff_token }}/operations/inventory/movements/" class="text-primary-600 text-sm hover:underline">{% trans "View all" %}</a>
            </div>
            {% if recent_movements %}
            <ul class="divide-y divide-gray-200">
                {% for movement in recent_movements %}
                <li class="p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-medium text-gray-900">{{ movement.product.name }}</p>
                            <p class="text-sm text-gray-500">{{ movement.get_movement_type_display }}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-medium {% if movement.quantity > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                {% if movement.quantity > 0 %}+{% endif %}{{ movement.quantity }}
                            </p>
                            <p class="text-xs text-gray-500">{{ movement.created_at|date:"M d, H:i" }}</p>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div class="p-8 text-center text-gray-500">
                {% trans "No recent movements" %}
            </div>
            {% endif %}
        </div>

        <!-- Locations -->
        <div class="bg-white rounded-xl shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <h2 class="font-semibold text-gray-900">{% trans "Stock Locations" %}</h2>
                <div class="flex gap-2">
                    <a href="/staff-{{ staff_token }}/operations/inventory/locations/add/" class="bg-primary-600 text-white px-3 py-1 rounded-lg text-sm font-semibold hover:bg-primary-700">
                        + {% trans "Add" %}
                    </a>
                    <a href="/staff-{{ staff_token }}/operations/inventory/locations/" class="text-primary-600 text-sm hover:underline py-1">{% trans "View all" %}</a>
                </div>
            </div>
            {% if locations %}
            <ul class="divide-y divide-gray-200">
                {% for location in locations %}
                <li class="p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">
                                {% if location.location_type.code == 'pharmacy' %}üíä
                                {% elif location.location_type.code == 'refrigerated' %}‚ùÑÔ∏è
                                {% elif location.location_type.code == 'controlled' %}üîí
                                {% elif location.location_type.code == 'warehouse' %}üè≠
                                {% elif location.location_type.requires_temperature_control %}‚ùÑÔ∏è
                                {% elif location.location_type.requires_restricted_access %}üîí
                                {% else %}üì¶{% endif %}
                            </span>
                            <div>
                                <p class="font-medium text-gray-900">{{ location.name }}</p>
                                <p class="text-sm text-gray-500">
                                    {% if location.location_type %}{{ location.location_type.name }}{% else %}{% trans "Unspecified" %}{% endif %}
                                    {% if location.item_count %}<span class="text-xs text-gray-400 ml-2">{{ location.item_count }} {% trans "items" %}</span>{% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            {% if location.low_stock_items %}
                            <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">{{ location.low_stock_items }} {% trans "low" %}</span>
                            {% endif %}
                            <a href="/staff-{{ staff_token }}/operations/inventory/stock/?location={{ location.pk }}" class="text-primary-600 text-sm hover:underline">
                                {% trans "View stock" %}
                            </a>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div class="p-8 text-center text-gray-500">
                {% trans "No locations configured" %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
