{% extends "base_staff.html" %}
{% load i18n %}

{% block title %}{% trans "Add Pet" %} - {{ person.get_full_name }}{% endblock %}

{% block staff_content %}
<div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">{% trans "Add Pet" %}</h1>
            <p class="text-gray-600 mt-1">{% trans "for" %} {{ person.get_full_name }}</p>
        </div>
        <a href="{% url 'parties:person_detail' pk=person.pk %}" class="text-primary-600 hover:underline">
            &larr; {% trans "Back to Person" %}
        </a>
    </div>

    <!-- Search Existing Pets -->
    <div class="bg-white rounded-xl shadow p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">{% trans "Search Existing Pets" %}</h2>
        <p class="text-gray-600 text-sm mb-4">{% trans "Find and link an existing pet to this person." %}</p>

        <div class="relative" x-data="petSearch()">
            <input type="text"
                   x-model="query"
                   @input.debounce.300ms="search()"
                   placeholder="{% trans 'Type pet name to search...' %}"
                   class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-primary-500 focus:border-primary-500">

            <!-- Search Results -->
            <div x-show="results.length > 0" x-cloak class="mt-4 border rounded-lg divide-y">
                <template x-for="pet in results" :key="pet.id">
                    <form method="post" class="p-4 hover:bg-gray-50" :class="pet.has_different_owner ? 'bg-amber-50' : ''">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="link_existing">
                        <input type="hidden" name="pet_id" :value="pet.id">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-medium text-gray-900" x-text="pet.name"></div>
                                <div class="text-sm text-gray-500">
                                    <span x-text="pet.species"></span>
                                    <template x-if="pet.breed">
                                        <span> &bull; <span x-text="pet.breed"></span></span>
                                    </template>
                                </div>
                                <template x-if="pet.owner">
                                    <div class="text-xs" :class="pet.has_different_owner ? 'text-amber-600 font-medium' : 'text-gray-400'">
                                        {% trans "Current owner:" %} <span x-text="pet.owner"></span>
                                    </div>
                                </template>
                                <template x-if="!pet.owner">
                                    <div class="text-xs text-green-600">{% trans "No current owner" %}</div>
                                </template>
                            </div>
                            <template x-if="!pet.has_different_owner">
                                <button type="submit" class="bg-primary-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-primary-700">
                                    {% trans "Link to Person" %}
                                </button>
                            </template>
                            <template x-if="pet.has_different_owner">
                                <button type="submit" class="bg-amber-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-amber-600" onclick="return confirm('{% trans "This pet is currently owned by another person. Are you sure you want to reassign ownership?" %}')">
                                    {% trans "Reassign" %}
                                </button>
                            </template>
                        </div>
                        <template x-if="pet.has_different_owner">
                            <div class="mt-2 text-xs text-amber-700 bg-amber-100 px-3 py-2 rounded">
                                ⚠️ {% trans "This pet will be removed from its current owner and assigned to this person." %}
                            </div>
                        </template>
                    </form>
                </template>
            </div>

            <div x-show="query.length >= 2 && results.length === 0 && !loading" x-cloak class="mt-4 text-gray-500 text-sm">
                {% trans "No pets found matching your search." %}
            </div>

            <div x-show="loading" x-cloak class="mt-4 text-gray-500 text-sm">
                {% trans "Searching..." %}
            </div>
        </div>
    </div>

    <!-- Or Create New Pet -->
    <div class="bg-white rounded-xl shadow p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">{% trans "Or Create New Pet" %}</h2>
        <p class="text-gray-600 text-sm mb-4">{% trans "Create a new pet record for this person." %}</p>

        <form method="post" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="action" value="create_new">

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "Pet Name" %} *</label>
                <input type="text" name="name" required
                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "Species" %} *</label>
                    <select name="species" required
                            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                        {% for value, label in species_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "Breed" %}</label>
                    <input type="text" name="breed"
                           class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                </div>
            </div>

            <div class="pt-4">
                <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">
                    {% trans "Create Pet" %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function petSearch() {
    return {
        query: '',
        results: [],
        loading: false,
        async search() {
            if (this.query.length < 2) {
                this.results = [];
                return;
            }
            this.loading = true;
            try {
                const response = await fetch(`{% url 'parties:person_search_pets' pk=person.pk %}?q=${encodeURIComponent(this.query)}`);
                const data = await response.json();
                this.results = data.pets;
            } catch (e) {
                console.error('Search failed:', e);
            }
            this.loading = false;
        }
    }
}
</script>
{% endblock %}
