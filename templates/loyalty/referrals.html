{% extends "base_portal.html" %}
{% load i18n humanize %}

{% block title %}{% trans "Referral Program" %}{% endblock %}

{% block portal_content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">{% trans "Referral Program" %}</h1>
            <p class="text-gray-600 mt-1">{% trans "Invite friends and earn bonus points" %}</p>
        </div>
        <a href="{% url 'loyalty:dashboard' %}" class="text-primary-600 hover:text-primary-700 font-medium">
            â† {% trans "Back" %}
        </a>
    </div>

    {% if referral_config and referral_config.is_active %}
    <!-- Referral Link Card -->
    <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl p-6 text-white mb-8">
        <h2 class="text-xl font-bold mb-2">{% trans "Your Referral Link" %}</h2>
        <p class="text-white/80 mb-4">{% trans "Share this link with friends to earn points when they sign up" %}</p>

        <div class="flex items-center gap-2">
            <input type="text" readonly value="{{ request.scheme }}://{{ request.get_host }}/register/?ref={{ referral_code }}"
                   class="flex-1 bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/50"
                   id="referral-link">
            <button onclick="copyReferralLink()" class="bg-white text-primary-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition">
                {% trans "Copy" %}
            </button>
        </div>

        <div class="mt-4 flex items-center gap-4 text-sm">
            <span>{% trans "Share:" %}</span>
            <a href="https://wa.me/?text={% trans 'Join Pet-Friendly and get bonus points!' %} {{ request.scheme }}://{{ request.get_host }}/register/?ref={{ referral_code }}"
               target="_blank" class="hover:text-white/80">
                ğŸ“± WhatsApp
            </a>
            <a href="mailto:?subject={% trans 'Join Pet-Friendly!' %}&body={% trans 'Sign up and get bonus points:' %} {{ request.scheme }}://{{ request.get_host }}/register/?ref={{ referral_code }}"
               class="hover:text-white/80">
                âœ‰ï¸ Email
            </a>
        </div>
    </div>

    <!-- How It Works -->
    <div class="bg-white rounded-xl shadow p-6 mb-8">
        <h2 class="text-xl font-bold text-gray-900 mb-4">{% trans "How It Works" %}</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="text-center">
                <div class="w-12 h-12 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center mx-auto mb-3 text-xl font-bold">
                    1
                </div>
                <h3 class="font-semibold text-gray-900">{% trans "Share Your Link" %}</h3>
                <p class="text-sm text-gray-500 mt-1">{% trans "Send your unique referral link to friends" %}</p>
            </div>
            <div class="text-center">
                <div class="w-12 h-12 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center mx-auto mb-3 text-xl font-bold">
                    2
                </div>
                <h3 class="font-semibold text-gray-900">{% trans "They Sign Up" %}</h3>
                <p class="text-sm text-gray-500 mt-1">{% trans "Your friend creates an account using your link" %}</p>
            </div>
            <div class="text-center">
                <div class="w-12 h-12 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center mx-auto mb-3 text-xl font-bold">
                    3
                </div>
                <h3 class="font-semibold text-gray-900">{% trans "You Both Earn" %}</h3>
                <p class="text-sm text-gray-500 mt-1">{% trans "Get points when they make their first purchase" %}</p>
            </div>
        </div>

        <div class="mt-6 p-4 bg-green-50 rounded-lg">
            <div class="flex items-center justify-center gap-8">
                <div class="text-center">
                    <p class="text-2xl font-bold text-green-600">+{{ referral_config.referrer_bonus }}</p>
                    <p class="text-sm text-gray-600">{% trans "points for you" %}</p>
                </div>
                <div class="text-gray-400">+</div>
                <div class="text-center">
                    <p class="text-2xl font-bold text-green-600">+{{ referral_config.referred_bonus }}</p>
                    <p class="text-sm text-gray-600">{% trans "points for your friend" %}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
        <div class="bg-white rounded-xl shadow p-6 text-center">
            <p class="text-3xl font-bold text-primary-600">{{ completed_count }}</p>
            <p class="text-gray-500">{% trans "Successful Referrals" %}</p>
        </div>
        <div class="bg-white rounded-xl shadow p-6 text-center">
            <p class="text-3xl font-bold text-yellow-600">{{ pending_count }}</p>
            <p class="text-gray-500">{% trans "Pending" %}</p>
        </div>
        <div class="bg-white rounded-xl shadow p-6 text-center">
            <p class="text-3xl font-bold text-green-600">+{{ total_points_earned|intcomma }}</p>
            <p class="text-gray-500">{% trans "Points Earned" %}</p>
        </div>
    </div>

    <!-- Referral History -->
    {% if referrals_made %}
    <div class="bg-white rounded-xl shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="font-semibold text-gray-900">{% trans "Your Referrals" %}</h2>
        </div>
        <ul class="divide-y divide-gray-200">
            {% for referral in referrals_made %}
            <li class="p-4 flex items-center justify-between">
                <div>
                    <p class="font-medium text-gray-900">{{ referral.referred_email }}</p>
                    <p class="text-sm text-gray-500">{% trans "Invited" %} {{ referral.created_at|date:"M d, Y" }}</p>
                </div>
                <div class="text-right">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                        {% if referral.status == 'completed' %}bg-green-100 text-green-800
                        {% elif referral.status == 'pending' %}bg-yellow-100 text-yellow-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ referral.get_status_display }}
                    </span>
                    {% if referral.status == 'completed' %}
                    <p class="text-sm text-green-600 mt-1">+{{ referral.referrer_points_awarded }} {% trans "points" %}</p>
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% else %}
    <!-- No Referral Program -->
    <div class="bg-gray-50 rounded-xl p-8 text-center">
        <div class="text-4xl mb-4">ğŸ‘¥</div>
        <h2 class="text-xl font-bold text-gray-900 mb-2">{% trans "Referral Program Coming Soon" %}</h2>
        <p class="text-gray-500">{% trans "Check back later for our referral program!" %}</p>
    </div>
    {% endif %}
</div>

<script>
function copyReferralLink() {
    const input = document.getElementById('referral-link');
    input.select();
    document.execCommand('copy');
    alert('{% trans "Link copied to clipboard!" %}');
}
</script>
{% endblock portal_content %}
