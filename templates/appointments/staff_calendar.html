{% extends "base_staff.html" %}
{% load static i18n %}

{% block breadcrumb %}
<li>
    <div class="flex items-center">
        <svg class="flex-shrink-0 w-5 h-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
        <span class="ml-2 text-sm font-medium text-gray-500">{% trans "Operations" %}</span>
    </div>
</li>
<li>
    <div class="flex items-center">
        <svg class="flex-shrink-0 w-5 h-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
        <span class="ml-2 text-sm font-medium text-gray-700">{% trans "Appointments" %}</span>
    </div>
</li>
{% endblock %}

{% block staff_content %}
<div class="space-y-6">
    <!-- Header with View Controls -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">{{ month_name }}</h1>
            <p class="text-sm text-gray-500 mt-1">
                {{ total_count }} {% trans "appointment" %}{{ total_count|pluralize:"s" }} {% trans "this month" %}
            </p>
        </div>

        <div class="flex flex-wrap items-center gap-3">
            <!-- View Switcher -->
            <div class="inline-flex rounded-lg border border-gray-200 bg-white p-1">
                <a href="?view=day&date={{ selected_date|date:'Y-m-d' }}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                   class="px-3 py-1.5 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-100">
                    {% trans "Day" %}
                </a>
                <a href="?view=week&date={{ selected_date|date:'Y-m-d' }}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                   class="px-3 py-1.5 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-100">
                    {% trans "Week" %}
                </a>
                <a href="?view=month&date={{ selected_date|date:'Y-m-d' }}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                   class="px-3 py-1.5 text-sm font-medium rounded-md bg-primary-100 text-primary-700">
                    {% trans "Month" %}
                </a>
            </div>

            <!-- Month Navigation -->
            <div class="inline-flex items-center rounded-lg border border-gray-200 bg-white">
                <a href="?view=month&date={{ prev_month|date:'Y-m-d' }}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                   class="px-2 py-1.5 hover:bg-gray-100 rounded-l-lg">
                    {% include "components/icons/feather.html" with icon="chevron-left" class="w-4 h-4" %}
                </a>
                <a href="?view=month&date={{ today|date:'Y-m-d' }}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                   class="px-3 py-1.5 text-sm font-medium hover:bg-gray-100">{% trans "Today" %}</a>
                <a href="?view=month&date={{ next_month|date:'Y-m-d' }}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                   class="px-2 py-1.5 hover:bg-gray-100 rounded-r-lg">
                    {% include "components/icons/feather.html" with icon="chevron-right" class="w-4 h-4" %}
                </a>
            </div>

            <!-- Location Filter -->
            <select id="location-filter" class="text-sm border-gray-300 rounded-md shadow-sm">
                <option value="">{% trans "All Locations" %}</option>
                {% for loc in locations %}
                <option value="{{ loc.id }}" {% if location_filter == loc.id|stringformat:'d' %}selected{% endif %}>{{ loc.name }}</option>
                {% endfor %}
            </select>

            <!-- Status Filter -->
            <select id="status-filter" class="text-sm border-gray-300 rounded-md shadow-sm">
                <option value="">{% trans "All Status" %}</option>
                <option value="scheduled" {% if status_filter == 'scheduled' %}selected{% endif %}>{% trans "Scheduled" %}</option>
                <option value="confirmed" {% if status_filter == 'confirmed' %}selected{% endif %}>{% trans "Confirmed" %}</option>
                <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>{% trans "In Progress" %}</option>
                <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>{% trans "Completed" %}</option>
            </select>

            <!-- New Appointment -->
            <a href="/staff-{{ staff_token }}/operations/appointments/add/" class="btn btn-primary">
                {% include "components/icons/feather.html" with icon="plus" class="w-4 h-4 mr-2" %}
                {% trans "New" %}
            </a>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <!-- Day Headers -->
        <div class="grid grid-cols-7 bg-gray-50 border-b border-gray-200">
            <div class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">{% trans "Mon" %}</div>
            <div class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">{% trans "Tue" %}</div>
            <div class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">{% trans "Wed" %}</div>
            <div class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">{% trans "Thu" %}</div>
            <div class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">{% trans "Fri" %}</div>
            <div class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">{% trans "Sat" %}</div>
            <div class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">{% trans "Sun" %}</div>
        </div>

        <!-- Calendar Weeks -->
        {% for week in calendar_weeks %}
        <div class="grid grid-cols-7 border-b border-gray-100 last:border-b-0">
            {% for day in week %}
            <div class="min-h-[120px] border-r border-gray-100 last:border-r-0
                {% if not day.in_month %}bg-gray-50{% endif %}
                {% if day.is_today %}bg-primary-50{% endif %}">
                <!-- Day Number -->
                <div class="flex items-center justify-between px-2 py-1">
                    <a href="?view=day&date={{ day.date|date:'Y-m-d' }}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                       class="text-sm font-medium {% if day.is_today %}text-primary-600{% elif day.in_month %}text-gray-900{% else %}text-gray-400{% endif %} hover:text-primary-600">
                        {{ day.date|date:"j" }}
                    </a>
                    {% if day.count > 0 %}
                    <span class="text-xs px-1.5 py-0.5 rounded-full {% if day.is_today %}bg-primary-100 text-primary-700{% else %}bg-gray-200 text-gray-600{% endif %}">
                        {{ day.count }}
                    </span>
                    {% endif %}
                </div>

                <!-- Appointment Previews -->
                <div class="px-1 pb-1 space-y-1">
                    {% for apt in day.appointments %}
                    <a href="/staff-{{ staff_token }}/operations/appointments/{{ apt.pk }}/"
                       class="block px-1.5 py-0.5 text-xs rounded truncate
                        {% if apt.status == 'scheduled' %}bg-blue-100 text-blue-700
                        {% elif apt.status == 'confirmed' %}bg-green-100 text-green-700
                        {% elif apt.status == 'in_progress' %}bg-yellow-100 text-yellow-700
                        {% elif apt.status == 'completed' %}bg-gray-100 text-gray-600
                        {% elif apt.status == 'cancelled' %}bg-red-100 text-red-700
                        {% elif apt.status == 'no_show' %}bg-orange-100 text-orange-700
                        {% endif %}"
                       title="{{ apt.pet.name }} - {{ apt.service.name }}{% if apt.location %} @ {{ apt.location.name }}{% endif %}">
                        {{ apt.scheduled_start|time:"H:i" }} {{ apt.pet.name|default:"?" }}{% if apt.location and not location_filter %}<span class="opacity-60"> ({{ apt.location.name|truncatechars:10 }})</span>{% endif %}
                    </a>
                    {% endfor %}
                    {% if day.has_more %}
                    <a href="?view=day&date={{ day.date|date:'Y-m-d' }}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                       class="block px-1.5 py-0.5 text-xs text-gray-500 hover:text-primary-600">
                        + {% trans "more" %}...
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>

    <!-- Legend -->
    <div class="flex flex-wrap items-center gap-4 text-xs">
        <span class="text-gray-500">{% trans "Status:" %}</span>
        <span class="flex items-center gap-1">
            <span class="w-3 h-3 rounded bg-blue-100 border border-blue-200"></span>
            {% trans "Scheduled" %}
        </span>
        <span class="flex items-center gap-1">
            <span class="w-3 h-3 rounded bg-green-100 border border-green-200"></span>
            {% trans "Confirmed" %}
        </span>
        <span class="flex items-center gap-1">
            <span class="w-3 h-3 rounded bg-yellow-100 border border-yellow-200"></span>
            {% trans "In Progress" %}
        </span>
        <span class="flex items-center gap-1">
            <span class="w-3 h-3 rounded bg-gray-100 border border-gray-200"></span>
            {% trans "Completed" %}
        </span>
    </div>
</div>

<script>
const selectedDate = new Date('{{ selected_date|date:"Y-m-d" }}');
const statusFilter = '{{ status_filter }}';
const locationFilter = '{{ location_filter }}';

function updateCalendarUrl() {
    const dateStr = selectedDate.toISOString().split('T')[0];
    const status = document.getElementById('status-filter').value;
    const location = document.getElementById('location-filter').value;

    let url = '?view=month&date=' + dateStr;
    if (status) url += '&status=' + status;
    if (location) url += '&location=' + location;
    window.location.href = url;
}

document.getElementById('status-filter').addEventListener('change', updateCalendarUrl);
document.getElementById('location-filter').addEventListener('change', updateCalendarUrl);
</script>
{% endblock %}
