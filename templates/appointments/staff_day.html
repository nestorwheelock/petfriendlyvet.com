{% extends "base_staff.html" %}
{% load static i18n %}

{% block breadcrumb %}
<li>
    <div class="flex items-center">
        <svg class="flex-shrink-0 w-5 h-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
        <span class="ml-2 text-sm font-medium text-gray-500">{% trans "Operations" %}</span>
    </div>
</li>
<li>
    <div class="flex items-center">
        <svg class="flex-shrink-0 w-5 h-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
        <span class="ml-2 text-sm font-medium text-gray-700">{% trans "Appointments" %}</span>
    </div>
</li>
{% endblock %}

{% block staff_content %}
<div class="space-y-6">
    <!-- Header with View Controls -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">{{ selected_date|date:"l, F j, Y" }}</h1>
            <p class="text-sm text-gray-500 mt-1">
                {{ total_count }} {% trans "appointment" %}{{ total_count|pluralize:"s" }}
                {% if selected_date == today %}
                    <span class="ml-2 px-2 py-0.5 text-xs font-medium bg-green-100 text-green-700 rounded-full">{% trans "Today" %}</span>
                {% endif %}
            </p>
        </div>

        <div class="flex flex-wrap items-center gap-3">
            <!-- View Switcher -->
            <div class="inline-flex rounded-lg border border-gray-200 bg-white p-1">
                <a href="?view=day&date={{ selected_date|date:'Y-m-d' }}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                   class="px-3 py-1.5 text-sm font-medium rounded-md bg-primary-100 text-primary-700">
                    {% trans "Day" %}
                </a>
                <a href="?view=week&date={{ selected_date|date:'Y-m-d' }}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                   class="px-3 py-1.5 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-100">
                    {% trans "Week" %}
                </a>
                <a href="?view=month&date={{ selected_date|date:'Y-m-d' }}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                   class="px-3 py-1.5 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-100">
                    {% trans "Month" %}
                </a>
            </div>

            <!-- Date Navigation -->
            <div class="inline-flex items-center rounded-lg border border-gray-200 bg-white">
                <button onclick="navigateDate(-1)" class="px-2 py-1.5 hover:bg-gray-100 rounded-l-lg">
                    {% include "components/icons/feather.html" with icon="chevron-left" class="w-4 h-4" %}
                </button>
                <a href="?view=day&date={{ today|date:'Y-m-d' }}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                   class="px-3 py-1.5 text-sm font-medium hover:bg-gray-100">{% trans "Today" %}</a>
                <button onclick="navigateDate(1)" class="px-2 py-1.5 hover:bg-gray-100 rounded-r-lg">
                    {% include "components/icons/feather.html" with icon="chevron-right" class="w-4 h-4" %}
                </button>
            </div>

            <!-- Date Picker -->
            <input type="date" id="date-picker" value="{{ selected_date|date:'Y-m-d' }}"
                   class="text-sm border-gray-300 rounded-md shadow-sm">

            <!-- Status Filter -->
            <select id="status-filter" class="text-sm border-gray-300 rounded-md shadow-sm">
                <option value="">{% trans "All Status" %}</option>
                <option value="scheduled" {% if status_filter == 'scheduled' %}selected{% endif %}>{% trans "Scheduled" %}</option>
                <option value="confirmed" {% if status_filter == 'confirmed' %}selected{% endif %}>{% trans "Confirmed" %}</option>
                <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>{% trans "In Progress" %}</option>
                <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>{% trans "Completed" %}</option>
            </select>

            <!-- New Appointment -->
            <a href="/staff-{{ staff_token }}/operations/appointments/add/" class="btn btn-primary">
                {% include "components/icons/feather.html" with icon="plus" class="w-4 h-4 mr-2" %}
                {% trans "New" %}
            </a>
        </div>
    </div>

    <!-- Timeline View -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        {% for slot in time_slots %}
        <div class="flex border-b border-gray-100 last:border-b-0 {% if slot.appointments %}bg-white{% else %}bg-gray-50{% endif %}">
            <!-- Time Label -->
            <div class="w-20 flex-shrink-0 px-4 py-3 border-r border-gray-100">
                <span class="text-sm font-medium text-gray-500">{{ slot.label }}</span>
            </div>

            <!-- Appointments for this hour -->
            <div class="flex-1 min-h-[60px] p-2">
                {% if slot.appointments %}
                <div class="space-y-2">
                    {% for item in slot.appointments %}
                    {% with apt=item.appointment enc=item.encounter %}
                    <div class="flex items-center justify-between p-3 rounded-lg border
                        {% if apt.status == 'scheduled' %}bg-blue-50 border-blue-200
                        {% elif apt.status == 'confirmed' %}bg-green-50 border-green-200
                        {% elif apt.status == 'in_progress' %}bg-yellow-50 border-yellow-200
                        {% elif apt.status == 'completed' %}bg-gray-50 border-gray-200
                        {% elif apt.status == 'cancelled' %}bg-red-50 border-red-200
                        {% elif apt.status == 'no_show' %}bg-orange-50 border-orange-200
                        {% endif %}">
                        <div class="flex items-center gap-4">
                            <!-- Time -->
                            <div class="text-sm font-semibold text-gray-900">
                                {{ apt.scheduled_start|time:"H:i" }}
                            </div>

                            <!-- Pet & Owner -->
                            <div>
                                <a href="/staff-{{ staff_token }}/operations/appointments/{{ apt.pk }}/"
                                   class="text-sm font-medium text-gray-900 hover:text-primary-600">
                                    {{ apt.pet.name|default:"No Pet" }}
                                </a>
                                <span class="text-gray-400 mx-1">â€¢</span>
                                <span class="text-sm text-gray-600">{{ apt.owner.get_full_name|default:apt.owner.email }}</span>
                            </div>

                            <!-- Service -->
                            <div class="hidden md:block">
                                <span class="text-sm text-gray-500">{{ apt.service.name }}</span>
                            </div>

                            <!-- Status Badge -->
                            <span class="px-2 py-0.5 text-xs font-medium rounded-full
                                {% if apt.status == 'scheduled' %}bg-blue-100 text-blue-700
                                {% elif apt.status == 'confirmed' %}bg-green-100 text-green-700
                                {% elif apt.status == 'in_progress' %}bg-yellow-100 text-yellow-700
                                {% elif apt.status == 'completed' %}bg-gray-100 text-gray-700
                                {% elif apt.status == 'cancelled' %}bg-red-100 text-red-700
                                {% elif apt.status == 'no_show' %}bg-orange-100 text-orange-700
                                {% endif %}">
                                {{ apt.get_status_display }}
                            </span>

                            {% if enc %}
                            <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-primary-100 text-primary-700">
                                {{ enc.get_pipeline_state_display }}
                            </span>
                            {% endif %}
                        </div>

                        <!-- Actions -->
                        <div class="flex items-center gap-2">
                            <a href="/staff-{{ staff_token }}/operations/appointments/{{ apt.pk }}/edit/"
                               class="btn btn-ghost btn-sm" title="{% trans 'Edit' %}">
                                {% include "components/icons/feather.html" with icon="edit-2" class="w-4 h-4" %}
                            </a>
                            {% if enc %}
                            <a href="/staff-{{ staff_token }}/operations/clinical/"
                               class="btn btn-primary btn-sm">
                                {% trans "Open" %}
                            </a>
                            {% elif apt.status in 'scheduled,confirmed' %}
                            <form method="post" action="/staff-{{ staff_token }}/operations/appointments/{{ apt.pk }}/check-in/" class="inline">
                                {% csrf_token %}
                                {% if not apt.location and locations.count == 1 %}
                                <input type="hidden" name="location_id" value="{{ locations.first.id }}">
                                {% endif %}
                                <button type="submit" class="btn btn-primary btn-sm">
                                    {% trans "Check In" %}
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                    {% endwith %}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    {% if not time_slots or total_count == 0 %}
    <div class="text-center py-12">
        {% include "components/icons/feather.html" with icon="calendar" class="w-12 h-12 mx-auto mb-4 text-gray-300" %}
        <p class="text-lg font-medium text-gray-500">{% trans "No appointments" %}</p>
        <p class="text-sm text-gray-400">{% trans "No appointments scheduled for this date." %}</p>
        <a href="/staff-{{ staff_token }}/operations/appointments/add/" class="btn btn-primary mt-4">
            {% include "components/icons/feather.html" with icon="plus" class="w-4 h-4 mr-2" %}
            {% trans "New Appointment" %}
        </a>
    </div>
    {% endif %}
</div>

<script>
const currentDate = new Date('{{ selected_date|date:"Y-m-d" }}');
const statusFilter = '{{ status_filter }}';

function navigateDate(days) {
    const newDate = new Date(currentDate);
    newDate.setDate(newDate.getDate() + days);
    const dateStr = newDate.toISOString().split('T')[0];
    let url = '?view=day&date=' + dateStr;
    if (statusFilter) url += '&status=' + statusFilter;
    window.location.href = url;
}

document.getElementById('date-picker').addEventListener('change', function() {
    let url = '?view=day&date=' + this.value;
    if (statusFilter) url += '&status=' + statusFilter;
    window.location.href = url;
});

document.getElementById('status-filter').addEventListener('change', function() {
    const dateStr = currentDate.toISOString().split('T')[0];
    let url = '?view=day&date=' + dateStr;
    if (this.value) url += '&status=' + this.value;
    window.location.href = url;
});
</script>
{% endblock %}
