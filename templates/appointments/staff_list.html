{% extends "base_staff.html" %}
{% load static i18n %}

{% block breadcrumb %}
<li>
    <div class="flex items-center">
        <svg class="flex-shrink-0 w-5 h-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
        <span class="ml-2 text-sm font-medium text-gray-500">{% trans "Operations" %}</span>
    </div>
</li>
<li>
    <div class="flex items-center">
        <svg class="flex-shrink-0 w-5 h-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
        <span class="ml-2 text-sm font-medium text-gray-700">{% trans "Appointments" %}</span>
    </div>
</li>
{% endblock %}

{% block staff_content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gray-900">{% trans "Today's Appointments" %}</h1>
        <div class="flex items-center gap-4">
            <!-- Date Filter -->
            <form method="get" class="flex items-center gap-2">
                <input type="date" name="date" value="{{ date_filter }}"
                       class="text-sm border-gray-300 rounded-md shadow-sm"
                       onchange="this.form.submit()">
                {% if status_filter %}
                <input type="hidden" name="status" value="{{ status_filter }}">
                {% endif %}
            </form>
            <!-- Status Filter -->
            <select onchange="window.location.href='?date={{ date_filter }}&status='+this.value"
                    class="text-sm border-gray-300 rounded-md shadow-sm">
                <option value="">{% trans "All Status" %}</option>
                <option value="scheduled" {% if status_filter == 'scheduled' %}selected{% endif %}>{% trans "Scheduled" %}</option>
                <option value="confirmed" {% if status_filter == 'confirmed' %}selected{% endif %}>{% trans "Confirmed" %}</option>
                <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>{% trans "In Progress" %}</option>
                <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>{% trans "Completed" %}</option>
            </select>
            <!-- New Appointment -->
            <a href="/staff-{{ staff_token }}/operations/appointments/add/" class="btn btn-primary">
                {% include "components/icons/feather.html" with icon="plus" class="w-4 h-4 mr-2" %}
                {% trans "New Appointment" %}
            </a>
        </div>
    </div>

    <!-- Bulk Actions Bar (hidden until selection) -->
    <div id="bulk-actions-bar" class="hidden bg-primary-50 border border-primary-200 rounded-lg p-4 flex items-center justify-between">
        <div class="flex items-center gap-2">
            <span class="text-sm font-medium text-primary-700">
                <span id="selected-count">0</span> {% trans "selected" %}
            </span>
            <button type="button" onclick="clearSelection()" class="text-sm text-primary-600 hover:underline">
                {% trans "Clear" %}
            </button>
        </div>
        <form id="bulk-form" method="post" action="/staff-{{ staff_token }}/operations/appointments/bulk/" class="flex items-center gap-2">
            {% csrf_token %}
            <div id="bulk-ids-container"></div>
            {% if locations.count > 1 %}
            <select name="location_id" class="text-sm border-gray-300 rounded-md">
                <option value="">{% trans "Select location..." %}</option>
                {% for loc in locations %}
                <option value="{{ loc.id }}">{{ loc.name }}</option>
                {% endfor %}
            </select>
            {% endif %}
            <select name="action" class="text-sm border-gray-300 rounded-md" required>
                <option value="">{% trans "Select action..." %}</option>
                <option value="check_in">{% trans "Check In All" %}</option>
                <option value="confirm">{% trans "Confirm All" %}</option>
                <option value="no_show">{% trans "Mark No Show" %}</option>
                <option value="cancel">{% trans "Cancel All" %}</option>
            </select>
            <button type="submit" class="btn btn-primary btn-sm">
                {% trans "Apply" %}
            </button>
        </form>
    </div>

    <!-- Appointments Table -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 w-10">
                        <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)"
                               class="h-4 w-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500">
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">{% trans "Time" %}</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">{% trans "Patient" %}</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">{% trans "Owner" %}</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">{% trans "Service" %}</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">{% trans "Status" %}</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">{% trans "Encounter" %}</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">{% trans "Actions" %}</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for item in appointments_data %}
                {% with apt=item.appointment enc=item.encounter %}
                <tr class="hover:bg-gray-50" data-appointment-id="{{ apt.pk }}">
                    <td class="px-4 py-4">
                        <input type="checkbox" name="row-select" value="{{ apt.pk }}" onchange="updateSelection()"
                               class="h-4 w-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {{ apt.scheduled_start|time:"H:i" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center mr-3">
                                {% include "components/icons/feather.html" with icon="heart" class="w-4 h-4 text-primary-600" %}
                            </div>
                            <div>
                                <a href="/staff-{{ staff_token }}/operations/appointments/{{ apt.pk }}/"
                                   class="text-sm font-medium text-gray-900 hover:text-primary-600">
                                    {{ apt.pet.name|default:"No Pet" }}
                                </a>
                                <div class="text-xs text-gray-500">
                                    {{ apt.pet.species|default:"" }}{% if apt.pet.breed %} / {{ apt.pet.breed }}{% endif %}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {{ apt.owner.get_full_name|default:apt.owner.email }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {{ apt.service.name }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded-full
                            {% if apt.status == 'scheduled' %}bg-blue-100 text-blue-700
                            {% elif apt.status == 'confirmed' %}bg-green-100 text-green-700
                            {% elif apt.status == 'in_progress' %}bg-yellow-100 text-yellow-700
                            {% elif apt.status == 'completed' %}bg-gray-100 text-gray-700
                            {% elif apt.status == 'cancelled' %}bg-red-100 text-red-700
                            {% elif apt.status == 'no_show' %}bg-orange-100 text-orange-700
                            {% endif %}">
                            {{ apt.get_status_display }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if enc %}
                        <!-- Encounter exists - show status/link -->
                        <a href="/staff-{{ staff_token }}/operations/clinical/"
                           class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-primary-100 text-primary-700 hover:bg-primary-200">
                            {% include "components/icons/feather.html" with icon="activity" class="w-3 h-3 mr-1" %}
                            {{ enc.get_pipeline_state_display }}
                        </a>
                        {% else %}
                        <!-- No encounter yet -->
                        <span class="text-xs text-gray-400">â€”</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                        <!-- Edit Button (always visible) -->
                        <a href="/staff-{{ staff_token }}/operations/appointments/{{ apt.pk }}/edit/"
                           class="btn btn-ghost btn-sm mr-2" title="{% trans 'Edit' %}">
                            {% include "components/icons/feather.html" with icon="edit-2" class="w-4 h-4" %}
                        </a>
                        {% if enc %}
                        <!-- Already checked in - link to encounter -->
                        <a href="/staff-{{ staff_token }}/operations/clinical/"
                           class="btn btn-sm btn-primary">
                            {% include "components/icons/feather.html" with icon="activity" class="w-4 h-4 mr-1" %}
                            {% trans "Open Encounter" %}
                        </a>
                        {% elif apt.status in 'scheduled,confirmed' %}
                        <!-- Check In Button -->
                        <form method="post" action="/staff-{{ staff_token }}/operations/appointments/{{ apt.pk }}/check-in/" class="inline">
                            {% csrf_token %}
                            {% if apt.location %}
                            <!-- Location already on appointment -->
                            {% elif locations.count == 1 %}
                            <input type="hidden" name="location_id" value="{{ locations.first.id }}">
                            {% else %}
                            <select name="location_id" class="text-xs border-gray-300 rounded mr-2">
                                {% for loc in locations %}
                                <option value="{{ loc.id }}">{{ loc.name }}</option>
                                {% endfor %}
                            </select>
                            {% endif %}
                            <button type="submit" class="btn btn-primary btn-sm">
                                {% include "components/icons/feather.html" with icon="log-in" class="w-4 h-4 mr-1" %}
                                {% trans "Check In" %}
                            </button>
                        </form>
                        <form method="post" action="/staff-{{ staff_token }}/operations/appointments/{{ apt.pk }}/no-show/" class="inline ml-2">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-ghost btn-sm text-orange-600"
                                    onclick="return confirm('{% trans "Mark as no-show?" %}')">
                                {% trans "No Show" %}
                            </button>
                        </form>
                        {% elif apt.status == 'no_show' %}
                        <span class="text-xs text-orange-600">{% trans "No Show" %}</span>
                        {% elif apt.status == 'completed' %}
                        <span class="text-xs text-gray-500">{% trans "Completed" %}</span>
                        {% elif apt.status == 'cancelled' %}
                        <span class="text-xs text-red-500">{% trans "Cancelled" %}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endwith %}
                {% empty %}
                <tr>
                    <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                        {% include "components/icons/feather.html" with icon="calendar" class="w-12 h-12 mx-auto mb-4 text-gray-300" %}
                        <p class="text-lg font-medium">{% trans "No appointments" %}</p>
                        <p class="text-sm">{% trans "No appointments scheduled for this date." %}</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
function updateSelection() {
    const checkboxes = document.querySelectorAll('input[name="row-select"]:checked');
    const count = checkboxes.length;
    const bar = document.getElementById('bulk-actions-bar');
    const countSpan = document.getElementById('selected-count');
    const container = document.getElementById('bulk-ids-container');

    countSpan.textContent = count;

    if (count > 0) {
        bar.classList.remove('hidden');
        // Update hidden inputs
        container.innerHTML = '';
        checkboxes.forEach(cb => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'appointment_ids';
            input.value = cb.value;
            container.appendChild(input);
        });
    } else {
        bar.classList.add('hidden');
    }

    // Update select-all state
    const allCheckboxes = document.querySelectorAll('input[name="row-select"]');
    const selectAll = document.getElementById('select-all');
    selectAll.checked = allCheckboxes.length > 0 && count === allCheckboxes.length;
    selectAll.indeterminate = count > 0 && count < allCheckboxes.length;
}

function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('input[name="row-select"]');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateSelection();
}

function clearSelection() {
    const checkboxes = document.querySelectorAll('input[name="row-select"]');
    checkboxes.forEach(cb => cb.checked = false);
    document.getElementById('select-all').checked = false;
    updateSelection();
}
</script>
{% endblock %}
