# fail2ban filter for Django WAF
# Place in /etc/fail2ban/filter.d/django-waf.conf
#
# This filter matches security events logged by the Django WAF middleware.
# The log format is: YYYY-MM-DD HH:MM:SS [SECURITY] EVENT_TYPE ip=X.X.X.X ...

[Definition]

# Match any security event that includes an IP address
# Events include:
#   FAILED_LOGIN - Failed authentication attempts
#   INVALID_TOKEN - Invalid dynamic URL tokens
#   RATE_LIMIT - Rate limit exceeded
#   PATTERN_DETECTED - SQL injection, XSS, path traversal
#   IP_BANNED - IP was auto-banned
#   BANNED_ACCESS - Banned IP attempted access
#   GEO_BLOCKED - Access from blocked country
#   DATA_LEAK_BLOCKED - Attempted data exfiltration blocked

failregex = \[SECURITY\]\s+(FAILED_LOGIN|INVALID_TOKEN|RATE_LIMIT|PATTERN_DETECTED|BANNED_ACCESS|GEO_BLOCKED|DATA_LEAK_BLOCKED)\s+ip=<HOST>

# Ignore legitimate events (if any patterns should be ignored)
ignoreregex =

# Date/time detection pattern
# Format: 2025-12-26 10:15:23
datepattern = ^%%Y-%%m-%%d %%H:%%M:%%S

# Mode: aggressive (count all matching lines)
mode = aggressive

# Maximum lines to match for multi-line log entries
maxlines = 1

# Notes:
# - The filter looks for security events with ip=<HOST> pattern
# - <HOST> is replaced by fail2ban with the actual IP regex
# - Events like IP_BANNED are informational, not counted as failures
